{% extends "base.html" %}
{% load humanize %}

{% block title %}Data Science Lab &middot; LAPD Insights{% endblock %}

{% block content %}
<section class="grid cards-grid lab-hero">
    <article class="card">
        <h4>Model accuracy</h4>
        <p class="value">{{ lab_headlines.accuracy }}</p>
        <p class="caption">Random forest classifier predicting LAPD priority</p>
    </article>
    <article class="card">
        <h4>Macro F1</h4>
        <p class="value">{{ lab_headlines.macro_f1 }}</p>
        <p class="caption">Balances precision and recall across classes</p>
    </article>
    <article class="card">
        <h4>Weighted F1</h4>
        <p class="value">{{ lab_headlines.weighted_f1 }}</p>
        <p class="caption">Volume-adjusted score (routine calls dominate)</p>
    </article>
</section>

<section class="grid lab-meta-grid">
    <article class="section">
        <div class="section-header">
            <h2>Experiment snapshot</h2>
            <p>Generated {{ lab_metadata.generated_at }} using {{ lab_metadata.algorithm }}</p>
        </div>
        <dl class="meta-list">
            <div>
                <dt>Algorithm</dt>
                <dd>{{ lab_metadata.algorithm }} &middot; {{ lab_metadata.n_features }} engineered features</dd>
            </div>
            <div>
                <dt>Target</dt>
                <dd>{{ lab_metadata.target|title }}</dd>
            </div>
            <div>
                <dt>Samples analysed</dt>
                <dd>{{ lab_metadata.n_samples }}</dd>
            </div>
            <div>
                <dt>Minority ratio</dt>
                <dd>{{ lab_metadata.minority_ratio }}</dd>
            </div>
            <div>
                <dt>Synthetic assist</dt>
                <dd>{% if lab_metadata.used_synthetic %}{{ lab_metadata.sampler }}{% else %}None{% endif %}</dd>
            </div>
        </dl>
        <div class="split-tags">
            {% for name, split in lab_metadata.splits.items %}
                <div class="split-tag">
                    <span>{{ name|title }} share</span>
                    <strong>{{ split.share }}</strong>
                    <small>{{ split.rows }} rows</small>
                </div>
            {% endfor %}
        </div>
    </article>
    <article class="section">
        <div class="section-header">
            <h2>Feature signal</h2>
            <p>Relative importance of engineered predictors</p>
        </div>
        <canvas id="featureChart"></canvas>
        <ul class="feature-list">
            {% for row in lab_feature_importances %}
                <li>
                    <span>{{ row.feature }}</span>
                    <strong>{{ row.importance }}%</strong>
                </li>
            {% empty %}
                <li>No feature insights available.</li>
            {% endfor %}
        </ul>
        <div class="metric-panels">
            {% for panel in lab_metric_panels %}
                <div class="metric-panel">
                    <h4>{{ panel.label }}</h4>
                    <p>Accuracy <strong>{{ panel.accuracy }}</strong></p>
                    <p>Precision <strong>{{ panel.precision }}</strong></p>
                    <p>Recall <strong>{{ panel.recall }}</strong></p>
                    <p>F1 <strong>{{ panel.f1 }}</strong></p>
                </div>
            {% empty %}
                <p class="meta-notes">Run the lab to populate validation/test metrics.</p>
            {% endfor %}
        </div>
    </article>
</section>

<section class="grid lab-analysis-grid">
    <article class="section">
        <div class="section-header">
            <h2>Confusion matrix</h2>
            <p>Observed vs. predicted LAPD priority levels</p>
        </div>
        <table class="table compact confusion-table">
            <thead>
                <tr>
                    <th>Actual &rarr; Predicted</th>
                    {% for label in lab_confusion_labels %}
                        <th>{{ label }}</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for row in lab_confusion_rows %}
                    <tr>
                        <th>{{ row.label }}</th>
                        {% for cell in row.cells %}
                            <td>
                                <div class="cm-cell">
                                    <span class="cm-count">{{ cell.raw|intcomma }}</span>
                                    <span class="cm-share">{{ cell.normalized|floatformat:2 }}</span>
                                </div>
                            </td>
                        {% endfor %}
                    </tr>
                {% empty %}
                    <tr><td colspan="4">No confusion matrix computed.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </article>
    <article class="section">
        <div class="section-header">
            <h2>Classification report</h2>
            <p>Precision, recall, and F1 by class</p>
        </div>
        <table class="table compact">
            <thead>
                <tr>
                    <th>Class</th>
                    <th>Precision</th>
                    <th>Recall</th>
                    <th>F1</th>
                    <th>Support</th>
                </tr>
            </thead>
            <tbody>
                {% for row in lab_classification_rows %}
                    <tr>
                        <td>{{ row.label }}</td>
                        <td>{{ row.precision }}</td>
                        <td>{{ row.recall }}</td>
                        <td>{{ row.f1 }}</td>
                        <td>{{ row.support|intcomma }}</td>
                    </tr>
                {% empty %}
                    <tr><td colspan="5">Classification summary unavailable.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </article>
</section>

<section class="grid lab-catalog-grid">
    <article class="section">
        <div class="section-header">
            <h2>Class distribution</h2>
            <p>Observed support across labelled outcomes</p>
        </div>
        <div class="chip-row">
            {% for item in lab_class_distribution %}
                <span class="chip">{{ item.label }} &middot; {{ item.count }} ({{ item.share }})</span>
            {% empty %}
                <span class="chip">Run the lab to populate class counts.</span>
            {% endfor %}
        </div>
    </article>
    <article class="section">
        <div class="section-header">
            <h2>Lab notes</h2>
            <p>Operational context for the current run</p>
        </div>
        {% if lab_notes %}
            <ul class="lab-notes-list">
                {% for note in lab_notes %}
                    <li>{{ note }}</li>
                {% endfor %}
            </ul>
        {% else %}
            <p class="lab-notes">Static model run for narrative purposes. Replace with live ML pipeline outputs for production.</p>
        {% endif %}
    </article>
</section>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const featureConfig = {{ feature_chart_json|safe }};
    if (Object.keys(featureConfig).length) {
        const ctx = document.getElementById('featureChart').getContext('2d');
        new Chart(ctx, {
            type: 'bar',
            data: featureConfig,
            options: {
                indexAxis: 'y',
                plugins: { legend: { display: false }},
                scales: {
                    x: { ticks: { color: '#e6edf7', callback: (value) => value + '%' }, grid: { color: 'rgba(255,255,255,0.08)' }},
                    y: { ticks: { color: '#e6edf7' }, grid: { display: false } }
                }
            }
        });
    }
</script>
{% endblock %}
